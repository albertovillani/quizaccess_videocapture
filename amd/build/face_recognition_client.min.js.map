{"version":3,"file":"face_recognition_client.min.js","sources":["../src/face_recognition_client.js"],"sourcesContent":["define(['jquery', 'core/modal_factory', 'core/modal_events', 'core/templates', 'core/ajax'],\n function($, ModalFactory, ModalEvents, Templates, ajax) {\n\n\n    //var streaming = false;\n    //var localstream = null;\n\n    var RecognitionClient = function() {\n\n        this.width = 210;    // We will scale the photo width to this\n        this.height = 0;     // This will be computed based on the input stream\n        this.streaming = false;\n\n        this.video = null;\n        this.canvas = null;\n        this.photo = null;\n        this.photoTarget = null;\n\n        this.stream = null;\n\n        this.flow = 'check'; // Default\n        this.step = 0;\n        this.uid = null;\n\n        this.takepicture = this.takepicture.bind(this);\n        this.formatDate = this.formatDate.bind(this);\n        this.releaseStream = this.releaseStream.bind(this);\n        this.clearphoto = this.clearphoto.bind(this);\n        this.setFlow = this.setFlow.bind(this);\n        this.setPhotoTarget = this.setPhotoTarget.bind(this);\n        this.setUid = this.setUid.bind(this);\n        this.saveandlogin = this.saveandlogin.bind(this);\n        this.checkUploadedPicture = this.checkUploadedPicture.bind(this);\n        this.checkPhoto = this.checkPhoto.bind(this);\n\n    };\n\n\n    RecognitionClient.prototype.setFlow = function(flow){\n        this.flow = flow;\n    };\n\n    RecognitionClient.prototype.setStep = function(step){\n        this.step = step;\n    };\n\n    RecognitionClient.prototype.setUid = function(uid){\n        this.uid = uid;\n    };\n\n    RecognitionClient.prototype.setPhotoTarget = function(photoTargetId){\n        this.photoTarget = document.getElementById(photoTargetId);\n    };\n\n\n    RecognitionClient.prototype.startVideoCap = function(videoid, canvasid, photoid){\n            this.streaming = false;\n            this.video = document.getElementById(videoid);\n            this.canvas = document.getElementById(canvasid);\n            this.photo = document.getElementById(photoid);\n\n            navigator.getMedia = ( navigator.getUserMedia ||\n                                   navigator.webkitGetUserMedia ||\n                                   navigator.mozGetUserMedia ||\n                                   navigator.msGetUserMedia);\n\n            navigator.getMedia(\n                {\n                video: true,\n                audio: false\n                },\n                function(stream) {\n                    this.stream = stream;\n                    if (navigator.mozGetUserMedia) {\n                      this.video.mozSrcObject = stream;\n                    } else if(navigator.webkitGetUserMedia){\n                      this.video.srcObject = stream;\n                    } else {\n                      var vendorURL = window.URL || window.webkitURL;\n                      this.video.src = vendorURL.createObjectURL(stream);\n                    }\n                    this.video.play();\n                }.bind(this),\n                function() {\n                    //console.log(\"An error occured! \" + err);\n                }\n\n            );\n\n\n            this.video.addEventListener('canplay', function(){\n                if (!this.streaming) {\n                    let height = this.video.videoHeight / (this.video.videoWidth/this.width);\n\n                    // Firefox currently has a bug where the height can't be read from\n                    // the video, so we will make assumptions if this happens.\n                    if (isNaN(height)) {\n                      height = this.width / (4/3);\n                    }\n\n                    this.height = height;\n\n                    this.video.setAttribute('width', this.width);\n                    this.video.setAttribute('height', height);\n                    this.canvas.setAttribute('width', this.width);\n                    this.canvas.setAttribute('height', height);\n                    this.streaming = true;\n                    if(this.flow == 'check' || this.flow == 'attempt'){\n                        window.setTimeout(this.takepicture, 1000);\n                    }else if(this.flow == 'upload'){\n                        window.setTimeout(this.saveandlogin, 1000);\n                    }\n                }\n\n            }.bind(this), false);\n\n\n    };\n\n    RecognitionClient.prototype.releaseStream = function(){\n        if(this.stream !== null){\n            this.stream.getTracks().forEach(function(track) {\n                track.stop();\n            });\n        }\n        this.stream = null;\n    };\n\n    // The width and height of the captured photo. We will set the\n    // width to the value defined here, but the height will be\n    // calculated based on the aspect ratio of the input stream.\n\n    RecognitionClient.prototype.takepicture = function(){\n\n        var context = this.canvas.getContext('2d');\n\n        if (this.width && this.height) {\n          this.canvas.width = this.width;\n          this.canvas.height = this.height;\n          context.drawImage(this.video, 0, 0, this.width, this.height);\n          context.font = \"10px Arial\";\n          var date = new Date();\n          context.fillText(this.formatDate(date), 20, 20);\n          var data = this.canvas.toDataURL('image/png');\n          if(this.flow == 'check' || this.flow == 'attempt'){\n              this.photo.setAttribute('src', data);\n              this.checkPhoto();\n          }else if(this.flow == 'shoot'){\n              if(this.step === 0){\n                  this.photoTarget.setAttribute('src', data);\n                  this.checkNewPicture();\n              }else{\n                  this.photo.setAttribute('src', data);\n              }\n          }else if(this.flow == 'upload'){\n              this.photo.setAttribute('src', data);\n          }\n        } else {\n          this.clearphoto();\n        }\n    };\n\n\n    RecognitionClient.prototype.checkPhoto = function(){\n        var promises = ajax.call([\n            { methodname: 'quizaccess_videocapture_check_snapshot', args: { file: this.photo.getAttribute('src'), target: null } }\n        ]);\n\n        promises[0].done(function(j) {\n            if(j.match > 0){\n                var event = document.createEvent(\"Event\");\n                event.initEvent(\"snapshotCheckSuccess\", true, true);\n                document.dispatchEvent(event);\n            }else{\n                document.dispatchEvent(new CustomEvent(\"snapshotCheckFailed\",\n                {'detail': {'remote_error': j.remote_error, 'httpcode': j.httpcode, 'failed_attempt': j.failed_attempt}}));\n            }\n        }).fail(function() {\n           //console.log(\"============ FAIL checkpicture()\");\n        });\n    };\n\n\n    RecognitionClient.prototype.checkNewPicture = function(){\n\n        var promises = ajax.call([\n            { methodname: 'quizaccess_videocapture_check_profile_picture',\n              args: { file: this.photoTarget.getAttribute('src'), uid: this.uid} }\n        ], true, false);\n\n        promises[0].done(function(j) {\n            if(j.success){\n                 this.photo_target.setAttribute('src', j.picture);\n                 var event = document.createEvent(\"Event\");\n                 event.initEvent(\"newpictureCheckSuccess\", true, true);\n                 document.dispatchEvent(event);\n\n            }else{\n                document.dispatchEvent(new CustomEvent(\"newpictureCheckFailed\",\n                {'detail': {'remote_error': j.remote_error, 'httpcode': j.httpcode, 'msgcod': j.msgcod}}));\n\n            }\n        }).fail(function() {\n            //console.log(\"============ FAIL checkNewPicture()\");\n        });\n\n    };\n\n    RecognitionClient.prototype.checkUploadedPicture = function(formData){\n        var promises = ajax.call([\n            { methodname: 'quizaccess_videocapture_check_uploaded_profile_picture',\n            args: { jsonformdata: JSON.stringify(formData), uid: this.uid} }\n        ], true, false);\n\n        promises[0].done(function(j) {\n            $('#upldretry').show();\n            if(j.success){\n                 this.photo_target.setAttribute('src', j.picture);\n                 var event = document.createEvent(\"Event\");\n                 event.initEvent(\"uploadedPictureCheckSuccess\", true, true);\n                 document.dispatchEvent(event);\n            }else{\n                document.dispatchEvent(new CustomEvent(\"ploadedPictureCheckFailed\",\n                {'detail': {'remote_error': j.remote_error, 'httpcode': j.httpcode, 'msgcod': j.msgcod}}));\n            }\n        }).fail(function() {\n            //console.log(\"============ FAIL checkUploadedPicture()\");\n        });\n\n    };\n\n\n    RecognitionClient.prototype.saveandlogin = function(){\n\n        this.takepicture();\n\n        var promises = ajax.call([\n            { methodname: 'quizaccess_videocapture_check_snapshot',\n             args: { file: this.photo.getAttribute('src'), target: this.photoTarget.getAttribute('src')}\n            }], true, false);\n\n        promises[0].done(function(j) {\n            if(j.match > 0){\n\n                promises = ajax.call([\n                    { methodname: 'quizaccess_videocapture_save_profile_picture',\n                      args: { file: this.photoTarget.getAttribute('src'), uid: this.uid} }\n                ], true, false);\n\n                promises[0].done(function(jj) {\n                    if(jj.success){\n                        var event = document.createEvent(\"Event\");\n                        event.initEvent(\"saveandloginCheckSuccess\", true, true);\n                        document.dispatchEvent(event);\n                    }else{\n                        //console.log(\"COULD NOT SAVE PROFILE PICTURE\");\n                    }\n                });\n\n            }else{\n                //var event = document.createEvent(\"Event\");\n                //event.initEvent(\"saveandloginCheckFailed\", true, true);\n                //document.dispatchEvent(event);\n                document.dispatchEvent(new CustomEvent(\"saveandloginCheckFailed\",\n                {'detail': {'remote_error': j.remote_error, 'httpcode': j.httpcode}}));\n            }\n        }.bind(this)).fail(function() {\n           //console.log(\"============ FAIL saveandlogin()\");\n        });\n\n    };\n\n    RecognitionClient.prototype.clearphoto = function(){\n        var context = this.canvas.getContext('2d');\n        context.fillStyle = \"#AAA\";\n        context.fillRect(0, 0, this.canvas.width, this.canvas.height);\n\n        var data = this.canvas.toDataURL('image/png');\n\n        this.photo.setAttribute('src', data);\n    };\n\n\n    RecognitionClient.prototype.formatDate = function(date){\n      var result = \"\";\n\n      result += date.getFullYear();\n      result += \"-\";\n\n      var month = date.getMonth() + 1;\n      result += this.padNumber(month);\n      result += \"-\";\n\n      result += this.padNumber(date.getDate());\n      result += \" \";\n\n      result += this.padNumber(date.getHours());\n      result += \":\";\n\n      result += this.padNumber(date.getMinutes());\n      result += \":\";\n\n      result += this.padNumber(date.getSeconds());\n\n      return result;\n    };\n\n    RecognitionClient.prototype.padNumber = function(n){\n        return (n > 9)?n:\"0\"+n;\n    };\n\n\n return new RecognitionClient();\n\n\n});"],"names":["define","$","ModalFactory","ModalEvents","Templates","ajax","RecognitionClient","width","height","streaming","video","canvas","photo","photoTarget","stream","flow","step","uid","takepicture","this","bind","formatDate","releaseStream","clearphoto","setFlow","setPhotoTarget","setUid","saveandlogin","checkUploadedPicture","checkPhoto","prototype","setStep","photoTargetId","document","getElementById","startVideoCap","videoid","canvasid","photoid","navigator","getMedia","getUserMedia","webkitGetUserMedia","mozGetUserMedia","msGetUserMedia","audio","mozSrcObject","srcObject","vendorURL","window","URL","webkitURL","src","createObjectURL","play","addEventListener","videoHeight","videoWidth","isNaN","setAttribute","setTimeout","getTracks","forEach","track","stop","context","getContext","drawImage","font","date","Date","fillText","data","toDataURL","checkNewPicture","call","methodname","args","file","getAttribute","target","done","j","match","event","createEvent","initEvent","dispatchEvent","CustomEvent","remote_error","httpcode","failed_attempt","fail","success","photo_target","picture","msgcod","formData","jsonformdata","JSON","stringify","show","promises","jj","fillStyle","fillRect","result","getFullYear","month","getMonth","padNumber","getDate","getHours","getMinutes","getSeconds","n"],"mappings":"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"}