{"version":3,"file":"face_recognition_client.min.js","sources":["../src/face_recognition_client.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Base functions for the face recognition process.\n *\n * @module     quizaccess_videocapture/face_recognition_client\n * @author     Alberto Villani <alberto.villani@abacotechnology.it>\n * @copyright  2022 Abaco Technology\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/modal_factory', 'core/modal_events', 'core/templates', 'core/ajax'],\n function($, ModalFactory, ModalEvents, Templates, ajax) {\n\n    var RecognitionClient = function() {\n\n        this.width = 210;\n        this.height = 0;\n        this.streaming = false;\n\n        this.video = null;\n        this.canvas = null;\n        this.photo = null;\n        this.photoTarget = null;\n\n        this.stream = null;\n\n        this.flow = 'check';\n        this.step = 0;\n        this.uid = null;\n\n        this.takepicture = this.takepicture.bind(this);\n        this.formatDate = this.formatDate.bind(this);\n        this.releaseStream = this.releaseStream.bind(this);\n        this.clearphoto = this.clearphoto.bind(this);\n        this.setFlow = this.setFlow.bind(this);\n        this.setPhotoTarget = this.setPhotoTarget.bind(this);\n        this.setUid = this.setUid.bind(this);\n        this.saveandlogin = this.saveandlogin.bind(this);\n        this.checkUploadedPicture = this.checkUploadedPicture.bind(this);\n        this.checkPhoto = this.checkPhoto.bind(this);\n\n    };\n\n\n    RecognitionClient.prototype.setFlow = function(flow){\n        this.flow = flow;\n    };\n\n    RecognitionClient.prototype.setStep = function(step){\n        this.step = step;\n    };\n\n    RecognitionClient.prototype.setUid = function(uid){\n        this.uid = uid;\n    };\n\n    RecognitionClient.prototype.setPhotoTarget = function(photoTargetId){\n        this.photoTarget = document.getElementById(photoTargetId);\n    };\n\n\n    RecognitionClient.prototype.startVideoCap = function(videoid, canvasid, photoid){\n            this.streaming = false;\n            this.video = document.getElementById(videoid);\n            this.canvas = document.getElementById(canvasid);\n            this.photo = document.getElementById(photoid);\n\n            var constraints = { video: true, audio: false };\n            var onSuccess = function(stream) {\n                this.stream = stream;\n                if ('srcObject' in this.video) {\n                    this.video.srcObject = stream;\n                } else if (navigator.mozGetUserMedia) {\n                    this.video.mozSrcObject = stream;\n                } else {\n                    var vendorURL = window.URL || window.webkitURL;\n                    this.video.src = vendorURL.createObjectURL(stream);\n                }\n                this.video.play();\n            }.bind(this);\n\n            var onError = function() {\n                //console.log(\"An error occurred! \" + err);\n            };\n\n            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {\n                navigator.mediaDevices.getUserMedia(constraints)\n                    .then(onSuccess)\n                    .catch(onError);\n            } else {\n                var getMedia = navigator.getUserMedia || navigator.webkitGetUserMedia ||\n                               navigator.mozGetUserMedia || navigator.msGetUserMedia;\n                if (getMedia) {\n                    getMedia.call(navigator, constraints, onSuccess, onError);\n                } else {\n                    //console.error(\"getUserMedia not supported\");\n                }\n            }\n\n\n            this.video.addEventListener('canplay', function(){\n                if (!this.streaming) {\n                    let height = this.video.videoHeight / (this.video.videoWidth/this.width);\n\n                    // Firefox currently has a bug where the height can't be read from\n                    // the video, so we will make assumptions if this happens.\n                    if (isNaN(height)) {\n                      height = this.width / (4/3);\n                    }\n\n                    this.height = height;\n\n                    this.video.setAttribute('width', this.width);\n                    this.video.setAttribute('height', height);\n                    this.canvas.setAttribute('width', this.width);\n                    this.canvas.setAttribute('height', height);\n                    this.streaming = true;\n                    if(this.flow == 'check' || this.flow == 'attempt'){\n                        window.setTimeout(this.takepicture, 1000);\n                    }else if(this.flow == 'upload'){\n                        window.setTimeout(this.saveandlogin, 1000);\n                    }\n                }\n\n            }.bind(this), false);\n\n\n    };\n\n    RecognitionClient.prototype.releaseStream = function(){\n        if(this.stream !== null){\n            this.stream.getTracks().forEach(function(track) {\n                track.stop();\n            });\n        }\n        this.stream = null;\n    };\n\n    // The width and height of the captured photo. We will set the\n    // width to the value defined here, but the height will be\n    // calculated based on the aspect ratio of the input stream.\n\n    RecognitionClient.prototype.takepicture = function(){\n\n        var context = this.canvas.getContext('2d');\n\n        if (this.width && this.height) {\n          this.canvas.width = this.width;\n          this.canvas.height = this.height;\n          context.drawImage(this.video, 0, 0, this.width, this.height);\n          context.font = \"10px Arial\";\n          var date = new Date();\n          context.fillText(this.formatDate(date), 20, 20);\n          var data = this.canvas.toDataURL('image/png');\n          if(this.flow == 'check' || this.flow == 'attempt'){\n              this.photo.setAttribute('src', data);\n              this.checkPhoto();\n          }else if(this.flow == 'shoot'){\n              if(this.step === 0){\n                  this.photoTarget.setAttribute('src', data);\n                  this.checkNewPicture();\n              }else{\n                  this.photo.setAttribute('src', data);\n              }\n          }else if(this.flow == 'upload'){\n              this.photo.setAttribute('src', data);\n          }\n        } else {\n          this.clearphoto();\n        }\n    };\n\n\n    RecognitionClient.prototype.checkPhoto = function(){\n        var promises = ajax.call([\n            { methodname: 'quizaccess_videocapture_check_snapshot', args: { file: this.photo.getAttribute('src'), target: null } }\n        ]);\n\n        promises[0].done(function(j) {\n            if(j.match > 0){\n                var event = document.createEvent(\"Event\");\n                event.initEvent(\"snapshotCheckSuccess\", true, true);\n                document.dispatchEvent(event);\n            }else{\n                document.dispatchEvent(new CustomEvent(\"snapshotCheckFailed\",\n                {'detail': {'remote_error': j.remote_error, 'httpcode': j.httpcode, 'failed_attempt': j.failed_attempt}}));\n            }\n        }).fail(function() {\n           //console.log(\"============ FAIL checkpicture()\");\n        });\n    };\n\n\n    RecognitionClient.prototype.checkNewPicture = function(){\n\n        var promises = ajax.call([\n            { methodname: 'quizaccess_videocapture_check_profile_picture',\n              args: { file: this.photoTarget.getAttribute('src'), uid: this.uid} }\n        ]);\n\n        promises[0].done(function(j) {\n            if(j.success){\n                 this.photo_target.setAttribute('src', j.picture);\n                 var event = document.createEvent(\"Event\");\n                 event.initEvent(\"newpictureCheckSuccess\", true, true);\n                 document.dispatchEvent(event);\n\n            }else{\n                document.dispatchEvent(new CustomEvent(\"newpictureCheckFailed\",\n                {'detail': {'remote_error': j.remote_error, 'httpcode': j.httpcode, 'msgcod': j.msgcod}}));\n\n            }\n        }).fail(function() {\n            //console.log(\"============ FAIL checkNewPicture()\");\n        });\n\n    };\n\n    RecognitionClient.prototype.checkUploadedPicture = function(formData){\n        var promises = ajax.call([\n            { methodname: 'quizaccess_videocapture_check_uploaded_profile_picture',\n            args: { jsonformdata: JSON.stringify(formData), uid: this.uid} }\n        ]);\n\n        promises[0].done(function(j) {\n            $('#upldretry').show();\n            if(j.success){\n                 this.photo_target.setAttribute('src', j.picture);\n                 var event = document.createEvent(\"Event\");\n                 event.initEvent(\"uploadedPictureCheckSuccess\", true, true);\n                 document.dispatchEvent(event);\n            }else{\n                document.dispatchEvent(new CustomEvent(\"ploadedPictureCheckFailed\",\n                {'detail': {'remote_error': j.remote_error, 'httpcode': j.httpcode, 'msgcod': j.msgcod}}));\n            }\n        }).fail(function() {\n            //console.log(\"============ FAIL checkUploadedPicture()\");\n        });\n\n    };\n\n    RecognitionClient.prototype.saveandlogin = function(){\n\n        this.takepicture();\n\n        var promises = ajax.call([\n            { methodname: 'quizaccess_videocapture_check_snapshot',\n             args: { file: this.photo.getAttribute('src'), target: this.photoTarget.getAttribute('src')}\n            }]);\n\n        promises[0].done(function(j) {\n            if(j.match > 0){\n\n                promises = ajax.call([\n                    { methodname: 'quizaccess_videocapture_save_profile_picture',\n                      args: { file: this.photoTarget.getAttribute('src'), uid: this.uid} }\n                ]);\n\n                promises[0].done(function(jj) {\n                    if(jj.success){\n                        var event = document.createEvent(\"Event\");\n                        event.initEvent(\"saveandloginCheckSuccess\", true, true);\n                        document.dispatchEvent(event);\n                    }else{\n                        //console.log(\"COULD NOT SAVE PROFILE PICTURE\");\n                    }\n                });\n\n            }else{\n                document.dispatchEvent(new CustomEvent(\"saveandloginCheckFailed\",\n                {'detail': {'remote_error': j.remote_error, 'httpcode': j.httpcode}}));\n            }\n        }.bind(this)).fail(function() {\n           //console.log(\"============ FAIL saveandlogin()\");\n        });\n\n    };\n\n    RecognitionClient.prototype.clearphoto = function(){\n        var context = this.canvas.getContext('2d');\n        context.fillStyle = \"#AAA\";\n        context.fillRect(0, 0, this.canvas.width, this.canvas.height);\n\n        var data = this.canvas.toDataURL('image/png');\n\n        this.photo.setAttribute('src', data);\n    };\n\n    RecognitionClient.prototype.formatDate = function(date){\n      var result = \"\";\n\n      result += date.getFullYear();\n      result += \"-\";\n\n      var month = date.getMonth() + 1;\n      result += this.padNumber(month);\n      result += \"-\";\n\n      result += this.padNumber(date.getDate());\n      result += \" \";\n\n      result += this.padNumber(date.getHours());\n      result += \":\";\n\n      result += this.padNumber(date.getMinutes());\n      result += \":\";\n\n      result += this.padNumber(date.getSeconds());\n\n      return result;\n    };\n\n    RecognitionClient.prototype.padNumber = function(n){\n        return (n > 9)?n:\"0\"+n;\n    };\n\n\n return new RecognitionClient();\n\n\n});"],"names":["define","$","ModalFactory","ModalEvents","Templates","ajax","RecognitionClient","width","height","streaming","video","canvas","photo","photoTarget","stream","flow","step","uid","takepicture","this","bind","formatDate","releaseStream","clearphoto","setFlow","setPhotoTarget","setUid","saveandlogin","checkUploadedPicture","checkPhoto","prototype","setStep","photoTargetId","document","getElementById","startVideoCap","videoid","canvasid","photoid","constraints","audio","onSuccess","srcObject","navigator","mozGetUserMedia","mozSrcObject","vendorURL","window","URL","webkitURL","src","createObjectURL","play","onError","mediaDevices","getUserMedia","then","catch","getMedia","webkitGetUserMedia","msGetUserMedia","call","addEventListener","videoHeight","videoWidth","isNaN","setAttribute","setTimeout","getTracks","forEach","track","stop","context","getContext","drawImage","font","date","Date","fillText","data","toDataURL","checkNewPicture","methodname","args","file","getAttribute","target","done","j","match","event","createEvent","initEvent","dispatchEvent","CustomEvent","remote_error","httpcode","failed_attempt","fail","success","photo_target","picture","msgcod","formData","jsonformdata","JSON","stringify","show","promises","jj","fillStyle","fillRect","result","getFullYear","month","getMonth","padNumber","getDate","getHours","getMinutes","getSeconds","n"],"mappings":"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"}